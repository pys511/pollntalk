/**
 * @auth   	: JEON JY
 * @date	: 20200705
 * 	공통 기능
 */

/*
 * 	화면 리플레시
 */
function refleshPage()
{
	location.reload();
}
/*
 * 	팝업 종료
 */
function closePopup()
{
	var popupBox	= document.getElementById("popupBox");
	var element		= document.getElementById("popup_frame");
	if (element != null)
		popupBox.removeChild(element);
	
	var joinPopup	= document.getElementById("popup");
	popup.style.display	= "none"	
}
/*
 *	로그인 레이어 팝업
 */
function goLogin()
{	
	closePopup();
	
	var popup	= document.getElementById("popup");
	popup.style.display	= "block";
	
	var popupBox	= document.getElementById("popupBox");
	var element		= document.getElementById("popup_frame");
	if (element == null)
	{
		element					= document.createElement("iframe");
		element.id				= "popup_frame";
		element.style.cssFloat	= "left";
		element.style.width		= "100%";
		element.style.height	= "500px";
		element.style.border	= "0px";
		element.frameborder		= "0";
		element.src				= "/popup.php?mode=login";
		popupBox.appendChild(element);
	}
}
/*
 *	회원가입 레이어 팝업
 */
function goSignup()
{
	closePopup();
	
	var popup	= document.getElementById("popup");
	popup.style.display	= "block";
	
	var popupBox	= document.getElementById("popupBox");
	var element		= document.getElementById("popup_frame");
	if (element == null)
	{
		element					= document.createElement("iframe");
		element.id				= "popup_frame";
		element.style.cssFloat	= "left";
		element.style.width		= "100%";
		element.style.height	= "655px";
		element.style.border	= "0px";
		element.frameborder		= "0";
		element.src				= "/popup.php?mode=sign_up";
		popupBox.appendChild(element);
	}
}
/*
 *	회원정보수정 레이어 팝업
 */
function goModification()
{
	closePopup();
	
	var popup	= document.getElementById("popup");
	popup.style.display	= "block";
	
	var popupBox	= document.getElementById("popupBox");
	var element		= document.getElementById("popup_frame");
	if (element == null)
	{
		element					= document.createElement("iframe");
		element.id				= "popup_frame";
		element.style.cssFloat	= "left";
		element.style.width		= "100%";
		element.style.height	= "655px";
		element.style.border	= "0px";
		element.frameborder		= "0";
		element.src				= "/popup.php?mode=modification";
		popupBox.appendChild(element);
	}
}
/*
 *	대표사진업로드 레이어 팝업
 */
function goFileUp()
{
	closePopup();
	
	var popup	= document.getElementById("popup");
	popup.style.display	= "block";
	
	var popupBox	= document.getElementById("popupBox");
	var element		= document.getElementById("popup_frame");
	if (element == null)
	{
		element					= document.createElement("iframe");
		element.id				= "popup_frame";
		element.style.cssFloat	= "left";
		element.style.width		= "100%";
		element.style.height	= "300px";
		element.style.border	= "0px";
		element.frameborder		= "0";
		element.src				= "/popup.php?mode=file_up";
		popupBox.appendChild(element);
	}
}

/*
 *	구독 처리
 */
function subscribeVote(memberSeq)
{
	var subscribeMemberSeq		= document.getElementById("subscribe_member_seq");
	subscribeMemberSeq.value	= memberSeq;
	var query					= core_ajax.instance().makeQuery(frmSubscribe, "");
	if (!query)
		return;
		
	core_ajax.instance().send(query, null, "/controller.php?mode=subscribe_proc", function(result)
	{
		if (result == "-1")
			return;
		
		if (result != "TRUE")
		{
			alert("구독 신청을 하는 중에 오류가 발생하였습니다.");
			return;
		}
		
		alert("구독 신청되었습니다.");
		return;
	});
}

/*
 *	메시지 전송
 */
function sendMessage(memberSeq, memberName, nTop)
{
	var popupmenubox	= document.getElementById("popupmenubox");
	popupmenubox.style.display	= "none";
			
	var messagebox				= document.getElementById("messagebox");
	messagebox.style.display	= "block";
	messagebox.style.top		= nTop + "px";
	
	var recvMemberSeq		= document.getElementById("recv_member_seq");
	recvMemberSeq.value		= memberSeq;
	
	var sendername			= document.getElementById("sendername");
	sendername.innerText	= "받는 이 : " + memberName;
	
	return;
}

/*
 *	메시지 박스 닫기
 */
function closeMessage()
{
	var messagecontext			= document.getElementById("messagecontext");
	messagecontext.value		= "";
		
	var messagebox				= document.getElementById("messagebox");
	messagebox.style.display	= "none";
	
	return;
}

/*
 *	원화 표시
 */
function numberWithCommas(x) 
{
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

/*
 *	검색 키워드 입력란에 표시
 */
function setSearchKeyword(keyword)
{
	var search		= document.getElementById("search");
	search.value	= keyword;
}

/*
 * 	페이지 공통 기능 처리
 */
window.addEventListener("load", function()
{
	
	$(document).keydown(function(event) {
    if ( event.keyCode == 27 || event.which == 27 ) {
			closePopup();
    	}
	});
	
	//로그인
	var login			= document.getElementById("login");
	if (login != null)
	{
		login.addEventListener("click", function()
		{
			goLogin();
		});
	}
	
	//회원가입
	var join			= document.getElementById("join");
	if (join != null)
	{
		join.addEventListener("click", function()
		{
			goSignup();
		});
	}
	
	var mlogin			= document.getElementById("mlogin");
	if (mlogin != null)
	{
		mlogin.addEventListener("click", function(login)
		{
			login.click();
		}.bind(this, login));
	}
	
	//logout
	var loginout		= document.getElementById("loginout");
	if (loginout != null)
	{
		loginout.addEventListener("click", function()
		{
			var result = window.confirm("로그아웃 하시겠습니까?");
			if (result)
				location.href	= "/logout.php";
		});
	}
	
	//회원정보 수정
	var modification			= document.getElementById("modification");
	if (modification != null)
	{
		modification.addEventListener("click", function()
		{
			goModification();
		});
	}
	
	//대표사진업로드
	var fileUp			= document.getElementById("file_up");
	if (fileUp != null)
	{
		fileUp.addEventListener("click", function()
		{
			goFileUp();
		});
	}
	
	var mjoin			= document.getElementById("mjoin");
	if (mjoin != null)
	{
		mjoin.addEventListener("click", function()
		{
			join.click();
		}.bind(this, join));
	}
	
	//모바일
	//검색창 선택시
	var search			= document.getElementById("search");
	search.addEventListener("focus", function()
	{
		var nWidth		= window.screen.width;
		if (nWidth <= 800)
		{
			var msearchbox				= document.getElementById("mobilesearchbox");
			msearchbox.style.display	= "block";
		}	
	});
	
	var closesearch		= document.getElementById("closesearch");
	closesearch.addEventListener("click", function()
	{
		mobilesearchbox.style.display	= "none";
	});
	
	//모바일
	//메뉴 버튼
	var mmenubutton		= document.getElementById("mobilemenubutton");
	mmenubutton.addEventListener("click", function()
	{
		if (mobilemenubox.style.display == "none")
			mobilemenubox.style.display	= "block";
		else
			mobilemenubox.style.display	= "none";
	});
	
	var mmenuclose		= document.getElementById("mmenuclose");
	mmenuclose.addEventListener("click", function()
	{
		mobilemenubox.style.display	= "none";
	});
	
	var votedispusers	= document.querySelectorAll(".votedispuser");
	for (var i = 0; i < votedispusers.length; i++)
	{
		dispuser		= votedispusers[i];
		dispuser.addEventListener("click", function(dispuser)
		{
			var nLeft			= getPosX(dispuser) + 55;
			var nTop			= getPosY(dispuser) + 25;
			var popupmenubox	= document.getElementById("popupmenubox");
			var display			= "display:none;";
			
			if (popupmenubox.style.display == "none")
				display			= "display:block;";
				
			popupmenubox.setAttribute("style", display + "top:" + nTop + "px;left:" + nLeft + "px;z-index:1102;");
			
			var memberSeq		= dispuser.dataset.member;
			var memberName		= dispuser.dataset.name;
			var subscribe		= document.getElementById("subscribe");
			subscribe.addEventListener("click", subscribeVote.bind(null, memberSeq));
			
			var messageLink		= document.getElementById("messageLink");
			messageLink.addEventListener("click", sendMessage.bind(null, memberSeq, memberName, nTop));
			
		}.bind(null, dispuser));
	}
	
	var messageButton		= document.getElementById("messagebutton");
	messageButton.addEventListener("click", function()
	{
		var messageContext	= document.getElementById("messagecontext");
		if (messageContext.value == "")
		{
			alert("메시지를 작성하셔야 합니다.");
			messageContext.focus();
			return;
		}
		
		var frmMessage	= document.getElementById("frmMessage");
		var query		= core_ajax.instance().makeQuery(frmMessage, "");
		if (!query)
			return;
		
		core_ajax.instance().send(query, null, "/controller.php?mode=message_proc", function(result)
		{
			closeMessage();
			if (result != "TRUE")
			{
				alert("상대에게 메시지를 보낼 수 없습니다.");
				return;
			}
			
			alert("전송되었습니다.");
			return;
		});
	});
	
	var messageclose	= document.getElementById("messageclose");
	messageclose.addEventListener("click", function()
	{
		closeMessage();
	});
	
	var altTime	= setInterval(function()
	{
		var query	= core_ajax.instance().send("", null, "/controller.php?mode=get_alert", function(result)
		{
			result	= JSON.parse(result);
				
			var alertImage		= document.getElementById("alertimage");
			var alertmessage	= document.getElementById("alertmessage");
			var alertlink		= document.getElementById("alertlink");
			var messageText 	= result.MESSAGE;
			var linkUrl			= "";
			
			if (result.ALERT_KIND == "1")
			{
				alertImage.src	= "/app/images/alert.png";
				linkUrl			= "/?mode=boardView&sub=notice&num=" + result.SEQ;
			}
			else 
			{
				alertImage.src	= "/app/images/message.png";
				messageText		+= " [" + result.SENDER + "]"; 
				linkUrl			= "/?mode=mypage&sub=message";
			}
				
			alertmessage.innerText	= messageText;
			alertlink.href			= linkUrl;
			
		});
		
		return;
	}, 5000);
	
	return;
});